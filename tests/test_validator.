import pytest
from validator import PasswordValidator


class TestPasswordValidator:
    """Tests para la clase PasswordValidator"""
    
    def test_min_length_pass(self):
        """Test: contraseña cumple longitud mínima"""
        validator = PasswordValidator()
        validator.min_length(8)
        is_valid, results, score = validator.validate("12345678")
        assert any(r['rule'] == 'Mínimo 8 caracteres' and r['passed'] for r in results)
    
    def test_min_length_fail(self):
        """Test: contraseña no cumple longitud mínima"""
        validator = PasswordValidator()
        validator.min_length(8)
        is_valid, results, score = validator.validate("1234")
        assert any(r['rule'] == 'Mínimo 8 caracteres' and not r['passed'] for r in results)
    
    def test_max_length_pass(self):
        """Test: contraseña cumple longitud máxima"""
        validator = PasswordValidator()
        validator.max_length(20)
        is_valid, results, score = validator.validate("12345")
        assert any(r['rule'] == 'Máximo 20 caracteres' and r['passed'] for r in results)
    
    def test_max_length_fail(self):
        """Test: contraseña excede longitud máxima"""
        validator = PasswordValidator()
        validator.max_length(10)
        is_valid, results, score = validator.validate("12345678901234567890")
        assert any(r['rule'] == 'Máximo 10 caracteres' and not r['passed'] for r in results)
    
    def test_uppercase_pass(self):
        """Test: contraseña tiene mayúsculas"""
        validator = PasswordValidator()
        validator.has_uppercase(1)
        is_valid, results, score = validator.validate("Password")
        assert any(r['rule'] == 'Al menos 1 mayúscula(s)' and r['passed'] for r in results)
    
    def test_uppercase_fail(self):
        """Test: contraseña no tiene mayúsculas"""
        validator = PasswordValidator()
        validator.has_uppercase(1)
        is_valid, results, score = validator.validate("password")
        assert any(r['rule'] == 'Al menos 1 mayúscula(s)' and not r['passed'] for r in results)
    
    def test_lowercase_pass(self):
        """Test: contraseña tiene minúsculas"""
        validator = PasswordValidator()
        validator.has_lowercase(1)
        is_valid, results, score = validator.validate("Password")
        assert any(r['rule'] == 'Al menos 1 minúscula(s)' and r['passed'] for r in results)
    
    def test_lowercase_fail(self):
        """Test: contraseña no tiene minúsculas"""
        validator = PasswordValidator()
        validator.has_lowercase(1)
        is_valid, results, score = validator.validate("PASSWORD")
        assert any(r['rule'] == 'Al menos 1 minúscula(s)' and not r['passed'] for r in results)
    
    def test_digits_pass(self):
        """Test: contraseña tiene dígitos"""
        validator = PasswordValidator()
        validator.has_digits(2)
        is_valid, results, score = validator.validate("Pass12")
        assert any(r['rule'] == 'Al menos 2 número(s)' and r['passed'] for r in results)
    
    def test_digits_fail(self):
        """Test: contraseña no tiene suficientes dígitos"""
        validator = PasswordValidator()
        validator.has_digits(2)
        is_valid, results, score = validator.validate("Pass1")
        assert any(r['rule'] == 'Al menos 2 número(s)' and not r['passed'] for r in results)
    
    def test_symbols_pass(self):
        """Test: contraseña tiene símbolos"""
        validator = PasswordValidator()
        validator.has_symbols(1)
        is_valid, results, score = validator.validate("Pass@123")
        assert any(r['rule'] == 'Al menos 1 símbolo(s)' and r['passed'] for r in results)
    
    def test_symbols_fail(self):
        """Test: contraseña no tiene símbolos"""
        validator = PasswordValidator()
        validator.has_symbols(1)
        is_valid, results, score = validator.validate("Pass123")
        assert any(r['rule'] == 'Al menos 1 símbolo(s)' and not r['passed'] for r in results)
    
    def test_no_spaces_pass(self):
        """Test: contraseña sin espacios"""
        validator = PasswordValidator()
        validator.no_spaces()
        is_valid, results, score = validator.validate("Password123")
        assert any(r['rule'] == 'Sin espacios' and r['passed'] for r in results)
    
    def test_no_spaces_fail(self):
        """Test: contraseña con espacios"""
        validator = PasswordValidator()
        validator.no_spaces()
        is_valid, results, score = validator.validate("Pass word 123")
        assert any(r['rule'] == 'Sin espacios' and not r['passed'] for r in results)
    
    def test_common_password_detection(self):
        """Test: detecta contraseñas comunes"""
        validator = PasswordValidator()
        validator.min_length(8)
        is_valid, results, score = validator.validate("password")
        assert any('común' in r['rule'].lower() and not r['passed'] for r in results)
    
    def test_sequence_detection(self):
        """Test: detecta secuencias"""
        validator = PasswordValidator()
        validator.min_length(5)
        is_valid, results, score = validator.validate("abc123")
        assert any('secuencia' in r['rule'].lower() and not r['passed'] for r in results)
    
    def test_repetition_detection(self):
        """Test: detecta caracteres repetidos"""
        validator = PasswordValidator()
        validator.min_length(5)
        is_valid, results, score = validator.validate("aaa111")
        assert any('repetido' in r['rule'].lower() and not r['passed'] for r in results)
    
    def test_complete_validation_valid(self):
        """Test: validación completa - contraseña válida"""
        validator = PasswordValidator()
        validator.min_length(8)\
                 .max_length(50)\
                 .has_uppercase(1)\
                 .has_lowercase(1)\
                 .has_digits(1)\
                 .has_symbols(1)\
                 .no_spaces()
        
        is_valid, results, score = validator.validate("MyP@ssw0rd")
        assert is_valid
        assert score >= 80
    
    def test_complete_validation_invalid(self):
        """Test: validación completa - contraseña inválida"""
        validator = PasswordValidator()
        validator.min_length(8)\
                 .max_length(50)\
                 .has_uppercase(1)\
                 .has_lowercase(1)\
                 .has_digits(1)\
                 .has_symbols(1)\
                 .no_spaces()
        
        is_valid, results, score = validator.validate("weak")
        assert not is_valid
        assert score < 50
    
    def test_score_calculation(self):
        """Test: cálculo de score"""
        validator = PasswordValidator()
        validator.min_length(8).has_uppercase(1)
        is_valid, results, score = validator.validate("Password")
        assert 0 <= score <= 100
    
    def test_generate_password_length(self):
        """Test: generador respeta longitud"""
        validator = PasswordValidator()
        validator.min_length(12)
        password = validator.generate_password(12)
        assert len(password) == 12
    
    def test_generate_password_rules(self):
        """Test: generador cumple reglas"""
        validator = PasswordValidator()
        validator.has_uppercase(2)\
                 .has_lowercase(2)\
                 .has_digits(2)\
                 .has_symbols(1)
        
        password = validator.generate_password(15)
        
        uppercase_count = sum(1 for c in password if c.isupper())
        lowercase_count = sum(1 for c in password if c.islower())
        digit_count = sum(1 for c in password if c.isdigit())
        
        assert uppercase_count >= 2
        assert lowercase_count >= 2
        assert digit_count >= 2
    
    def test_chaining(self):
        """Test: encadenamiento de métodos"""
        validator = PasswordValidator()
        result = validator.min_length(8).max_length(20).has_uppercase(1)
        assert isinstance(result, PasswordValidator)
